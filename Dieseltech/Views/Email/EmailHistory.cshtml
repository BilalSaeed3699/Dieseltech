@using Dieseltech.Models;

@{
    ViewBag.Title = "Email History";

    List<Sp_Get_LoadDetail_FilterWise_Result> list = (List<Sp_Get_LoadDetail_FilterWise_Result>)ViewBag.LoadDetails;
    List<tblEmailHistory> ListEmailHistory = (List<tblEmailHistory>)ViewBag.EmailHistory;




}

<head>
    <style>
        .FilterButton {
            margin: 5px;
        }

        .fa-check-square {
        }

        #btnView {
            font-size: 12px !important;
        }

        .hiddenRow {
            padding: 0 !important;
        }
    </style>
</head>

<div class="content">
    <div class="row">
        <div class="col-sm-4 col-3">
            <h4 class="page-title">Loads List</h4>
            <span style="color:red;" id="fademsg">@ViewBag.error</span>
        </div>
    </div>

    @using (Html.BeginForm("Index", "Report", FormMethod.Post))
    {
        @Html.AntiForgeryToken()
        <form>
            <div class="row">
                <div class="col-sm-12 col-md-12">
                    @*<div class="form-group" >
                            <select class="form-control" name="Filter" id="ddlLoadType" style="height: 35px !important;">
                                <option value="0">Select Load</option>
                                <option value="D">Daily</option>
                                <option value="W">Weekly</option>
                                <option value="M">Monthly</option>
                            </select>
                        </div>*@

                    <div class="controls">
                        <label><bold> Load Filter: </bold></label>
                        <div class="btn-group">
                            <button name="Filter" value="D" onclick="GetFilterTypeValue('D')" class="btn btn-primary FilterButton">Daily</button>
                            <button name="Filter" value="W" onclick="GetFilterTypeValue('W')" class="btn btn-primary FilterButton">Weekly</button>
                            <button name="Filter" value="M" onclick="GetFilterTypeValue('M')" class="btn btn-primary FilterButton">Monthly</button>
                            <button name="Filter" value="0" onclick="GetFilterTypeValue('0')" class="btn btn-primary FilterButton">All</button>
                        </div>
                        <div class="btn-group" style="float:right">
                            @*<i class="fa fa-circle" style="color:darkorange;font-size:15px" aria-hidden="true"> Confo</i>
                                &nbsp;
                                <i class="fa fa-circle" style="color:darkgreen;font-size:15px" aria-hidden="true"> Confo POD</i>
                                &nbsp;
                                <i class="fa fa-circle" style="color:blue;font-size:15px" aria-hidden="true"> Confo POD,Invoice</i>*@

                            <button name="Filter" value="F" onclick="GetFilterTypeValue('F')" style="background-color: #6c757d !important" class="btn btn-secondary FilterButton"><i class="fa fa-history"></i> Future Loads</button>
                            <button name="Filter" value="A" onclick="GetFilterTypeValue('M')" style="background-color: #218838 !important" class="btn btn-success FilterButton"><i class="fa fa-check"></i> Active</button>
                            <button name="Filter" value="C" onclick="GetFilterTypeValue('0')" style="background-color: #e6294b !important" class="btn btn-primary FilterButton"><i class="fa fa-window-close"></i> Canceled</button>

                        </div>
                        @*<label class="radio-inline" style="font-size:18px">
                                <input type="radio" id="rdbDaily" onchange="GetFilterTypeValue('D')" name="Filter" value="D">
                                Daily
                            </label>
                            <label class="radio-inline" style="font-size:18px">
                                <input type="radio" id="rdbWeekly" name="Filter" onchange="GetFilterTypeValue('W')" value="W">
                                Weekly
                            </label>
                            <label class="radio-inline" style="font-size:18px">
                                <input type="radio" id="rdbMonthly" name="Filter" onchange="GetFilterTypeValue('M')" value="M">
                                Monthly
                            </label>
                            <label class="radio-inline" style="font-size:18px">
                                <input type="radio" id="rdbAll" name="Filter" onchange="GetFilterTypeValue('0')" value="0">
                                All
                            </label>
                            <button id="btnAddSearch" href="#"
                                    class="btn btn-secondary" style="background-color: #4c5564 !important">
                                <i class="fa fa-search"></i>Search
                            </button>*@
                        <input type="text" id="FilterType" name="Type" value="0" class="form-control" hidden />
                    </div>





                </div>
                <!--<div class="col-sm-2 col-md-2 float-left" >-->
                @*<button id="btnAddSearch" type="button" class="btn btn-success btn-block"> Search </button>*@
                <!--<button onclick="changeLabel('P')" id="btnAddSearch" href="#"
                            class="btn btn-secondary">
                        <i class="fa fa-search"></i>Search
                    </button>

                </div>-->

            </div>
            <br />

            <div class="row">
                <div class="col-md-12">
                    <div class="table-responsive">
                        <table style="font-size:12px" id="DailyLoads" class="table table-border table-striped table-sm custom-table mb-0 g-dataTable">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Status</th>
                                    <th>C.O.D</th>
                                    <th>Load Number </th>
                                    <th>Future Load</th>
                                    <th>Date</th>
                                    <th>Agent </th>
                                    <th>Profile </th>
                                    <th>Customer </th>
                                    <th>Carrier </th>

                                    <th>Load Type </th>
                                    @*<th>Pickup Location </th>
                                        <th>Pickup Date </th>
                                        <th>Delivery Location</th>
                                        <th>Delivery Date</th>*@
                                    <th>Broker Amount </th>
                                    <th>Carrier Amount </th>
                                    <th>Agent Amount </th>

                                    <th>View </th>
                                    @*<th>IsCancel</th>*@



                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in list)
                                {


                                    <tr data-toggle="collapse" data-target="#Load_@item.LoaderNumber" class="accordion-toggle">
                                        <td><button data-toggle="tooltip" data-placement="top" title="Click to view Email History" type="button" class="fa fa-eye"><span class="glyphicon glyphicon-eye-open"></span></button></td>
                                        @if (@item.IsCancel == 0)
                                        {

                                            <td onclick="LoadApprovalStatus(@item.IsCancel,'@item.LoaderNumber')"><i class="fa fa-check-square" style="font-size: 25px;color: #218838"></i></td>
                                        }
                                        else if (@item.IsCancel == 1)
                                        {
                                            <td onclick="LoadApprovalStatus(@item.IsCancel,'@item.LoaderNumber')"><i class="fa fa-window-close" style="font-size: 25px;color:Red"></i></td>
                                        }

                                        <td>@item.COD</td>
                                        <td class="LoadNumber"> <a> @item.LoaderNumber</a></td>
                                        <td class="FutureLoad"> <a style="color: #009efb" target="_blank" href="@Url.Action("Index", "CopyLoad", new { LoadNumber = @item.LoaderNumber })"> @item.FutureLoadText</a></td>

                                        @*<td class="LoadNumber"> <a style="color: #009efb" target="_blank" href="@Url.Action("EditLoad", "Load", new { LoaderNumber = @item.LoaderNumber })"> @item.LoaderNumber</a></td>*@
                                        <td>@item.RegistrationDate</td>
                                        <td>@item.Agent</td>

                                        <td>@item.Profile</td>
                                        <td>@item.Brokernanme</td>
                                        <td class="LoadReportNumber"> <a style="color: #009efb" target="_blank" href="@Url.Action("LoadConfirmation", "Load", new { LoaderNumber = @item.LoaderNumber })"> @item.CarrierName</a></td>

                                        <td>@item.LoadTypeName</td>

                                        @*<td>@item.PickupInfo</td>
                                            <td>@item.PickupDate</td>
                                            <td>@item.DeliveryInfo</td>
                                            <td>@item.DeliveryDate</td>*@
                                        <td>@item.BrokerRate</td>
                                        <td>@item.CarrierRate</td>
                                        <td>@item.Profit</td>
                                        <td style="width:7%">
                                            <a id="btnView" target="_blank" href="@Url.Action("ReportPreview", "Report", new { LoadNumberModel = @item.LoaderNumber })" class="btn btn-sm bg-info-light">
                                                <i class="fa fa-eye"></i> View
                                            </a>
                                        </td>





                                    </tr>

                                    //Email History table
                                    //foreach (var items in ListEmailHistory)
                                    //{
                                    //    if (items.LoadNumber == item.LoaderNumber)
                                    //    {
                                    <tr style="width:100%">
                                        <td colspan="12" class="hiddenRow">
                                            <div class="accordian-body collapse" id="Load_@item.LoaderNumber">
                                                <table class="table table-striped">
                                                    <thead>
                                                        <tr class="info">
                                                            <th>Load Number</th>
                                                            <th>Send To Email</th>
                                                            <th>Subject</th>
                                                            <th>Date</th>
                                                            <th>IsSend </th>
                                                            @*<th>Send Status</th>*@
                                                            <th>Send Message</th>
                                                        </tr>
                                                    </thead>

                                                    <tbody>
                                                        @{int i = 0;}
                                                        @foreach (var items in ListEmailHistory)
                                                        {

                                                            if (items.LoadNumber == item.LoaderNumber)
                                                            {
                                                                i++;
                                                                <tr data-toggle="collapse" class="accordion-toggle">
                                                                    <td>@items.LoadNumber</td>
                                                                    <td>@items.Email</td>
                                                                    <td>@items.Subject</td>
                                                                    <td>@items.Date.ToString("MM/dd/yyyy")</td>
                                                                    <td>
                                                                        @if (items.IsSend == 0)
                                                                        {
                                                                            <span class="badge badge-danger">Failed</span>
                                                                        }
                                                                        else if (items.IsSend == 1)
                                                                        {
                                                                            <span class="badge badge-success">Send</span>
                                                                        }
                                                                    </td>
                                                                    @*<td>
                                                                            @if (items.IsSend == 0)
                                                                            {
                                                                                <span class="badge badge-danger">@items.SendStatus</span>
                                                                            }
                                                                            else if (items.IsSend == 1)
                                                                            {
                                                                        <span class="badge badge-success">@items.SendStatus</span>
                                                                            }
                                                                        </td>*@
                                                                    <td>@items.Detail</td>

                                                                </tr>
                                                            }
                                                            @*else
                                                                {
                                                                    <tr data-toggle="collapse" class="accordion-toggle">
                                                                        <td colspan="7">No Email Send</td>
                                                                    </tr>
                                                                }*@
                                                        }

                                                        @if (i == 0)
                                                        {
                                                            <tr data-toggle="collapse" class="accordion-toggle">
                                                                <td colspan="7" class="text-center"><strong style="font-size:15px;font-weight:bold">No Email Send</strong></td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>

                                            </div>
                                        </td>
                                    </tr>
                                    //    }


                                    //}
                                }


                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </form>
    }
</div>

<div id="Cancel_Load" class="modal fade Load-modal" role="dialog">
    <div class="modal-dialog " style="max-width:500px">

        <div class="modal-content">

            <div class="modal-body text-center">
                <input type="text" id="LoadNumber" name="LoadNumber" class="form-control" hidden />
                <input type="text" id="LoadStatus" name="LoadStatus" class="form-control" hidden />
                <img src="~/assets/img/sent.png" alt="" width="50" height="46">
                <h3 id="MessageHeading"></h3>
                <div class="m-t-20">
                    <a href="#" class="btn btn-white" data-dismiss="modal">No</a>

                    <button type="button" onclick="CancelLoad()" style="background-color: #4c5564 !important;border: 1px solid #4c5564" class="btn btn-danger">Yes</button>
                </div>
            </div>
        </div>

    </div>

</div>


@*<script>
        $(document).ready(function () {
            $('#DailyLoads').DataTable();
        });

    </script>*@

<script>


    function LoadApprovalStatus(status, LoadNumber) {
        //var status;
        //if (status.checked) {
        //    status = 1;
        //}
        //else {
        //    status = 0;
        //}
        //alert(status);
        //$("#Cancel_Load").show();

        if (status == 0) {
            document.getElementById("MessageHeading").innerHTML = "Are you sure you want to Cancel Load#: " + LoadNumber + " ";
            $("#LoadStatus").val(1);
        }
        else if (status == 1) {
            document.getElementById("MessageHeading").innerHTML = "Are you sure you want to Active Load#: " + LoadNumber + " ";
            $("#LoadStatus").val(0);
        }

        $("#LoadNumber").val(LoadNumber);



        $('#Cancel_Load').modal('show');



    }


    function CancelLoad() {



        var LoadNumber = $("#LoadNumber").val();
        var LoadStatus = $("#LoadStatus").val();
        $.ajax({

            type: "POST",
            url: "/Load/UpdateLoadStatus/?LoadNumber=" + LoadNumber + "&LoadStatus=" + LoadStatus + "",

            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data == "1") {
                    location.reload();

                }
                else {

                }


            }




        });
    }


    function changeLabel(LoadType) {

        //var Filter = $("#ddlLoadType").find("option:selected").val();

        //alert(LoadType);

        var model = {
            Filter: LoadType,
        };

        //Send the JSON array to Controller using AJAX.
        $.ajax({

            type: "POST",
            url: "/Report/FilterLodList",
            data: JSON.stringify(model),
            //data: { 'ListOfVariants': customers },
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {

                $("#DailyLoads").html(data);
            }
        });


    }
</script>
<script>
    @*$(document).ready(function () {
        if ("@ViewBag.Type" == "0" ) {
            document.getElementById("rdbAll").checked = true;
        }
        else if ("@ViewBag.Type" == "M" ) {
            document.getElementById("rdbMonthly").checked = true;
        }
          else if ("@ViewBag.Type" == "W" ) {
            document.getElementById("rdbWeekly").checked = true;
        }
          else if ("@ViewBag.Type" == "D" ) {
            document.getElementById("rdbDaily").checked = true;
        }


    });*@
    function GetFilterTypeValue(type) {


        $("#FilterType").val(type);
    }
    $("body").on("click", "#btnAddSearch", function () {


    });

</script>




